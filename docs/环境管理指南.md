# MediaBot 环境管理指南

## 环境层次结构

```
Conda (系统层) → Poetry (项目层) → 虚拟环境 (隔离层)
```

## 初次设置

### 1. 安装基础工具
```bash
# 安装miniconda
# 下载：https://docs.anaconda.com/miniconda/

# 创建Python环境
conda create -n py311 python=3.11
conda activate py311

# 安装Poetry
conda install poetry
# 或者 pip install poetry
```

### 2. 配置Poetry
```bash
# 配置在项目内创建虚拟环境
poetry config virtualenvs.in-project true

# 查看配置
poetry config --list
```

### 3. 项目初始化
```bash
# 克隆项目
git clone <repo>
cd MediaBot

# 激活conda环境
conda activate py311

# 安装项目依赖
poetry install
```

## 日常开发

### 添加依赖
```bash
# 添加生产依赖
poetry add playwright

# 添加开发依赖
poetry add --group dev pytest

# 添加指定版本
poetry add "playwright>=1.40.0"
```

### 更新依赖
```bash
# 更新所有包
poetry update

# 更新指定包
poetry update playwright

# 查看过期包
poetry show --outdated
```

### 运行项目
```bash
# 方法1：使用poetry run
poetry run python main.py demo

# 方法2：激活虚拟环境
poetry shell
python main.py demo
```

## 团队协作

### 新成员设置
```bash
# 1. 安装conda和poetry
# 2. 创建Python环境
conda create -n py311 python=3.11
conda activate py311

# 3. 克隆项目
git clone <repo>
cd MediaBot

# 4. 安装依赖（使用锁定版本）
poetry install
```

### 依赖同步
- `pyproject.toml`: 依赖声明和版本范围
- `poetry.lock`: 锁定的具体版本，确保团队一致性
- 两个文件都应该提交到git

### 生产部署
```bash
# 只安装生产依赖
poetry install --only=main

# 或者导出requirements.txt
poetry export -f requirements.txt --output requirements.txt
pip install -r requirements.txt
```

## 环境切换

### 项目间切换
```bash
# 每个项目有独立的虚拟环境
cd ProjectA
conda activate py311
poetry shell

cd ProjectB  
conda activate py312
poetry shell
```

### 快速激活脚本
```bash
# 创建激活脚本
echo '#!/bin/bash
conda activate py311
cd /path/to/MediaBot
poetry shell' > ~/bin/activate-mediabot

chmod +x ~/bin/activate-mediabot
```

## 故障排除

### 重建环境
```bash
# 删除虚拟环境
rm -rf .venv
poetry env remove python

# 重新创建
poetry install
```

### 依赖冲突
```bash
# 查看依赖树
poetry show --tree

# 重新解析依赖
poetry lock --no-update
poetry install
```

### 缓存清理
```bash
# 清理Poetry缓存
poetry cache clear pypi --all

# 清理conda缓存
conda clean --all
```

## 最佳实践

1. **版本管理**：
   - Conda管理Python版本
   - Poetry管理项目依赖
   - 不要混用pip和poetry

2. **环境隔离**：
   - 每个项目独立虚拟环境
   - 不要在base环境安装包

3. **依赖锁定**：
   - 开发时用poetry add
   - 生产部署用poetry.lock
   - 定期更新依赖

4. **团队协作**：
   - 提交pyproject.toml和poetry.lock
   - 不提交.venv目录
   - 统一Python版本

## 当前项目状态

```bash
# 环境信息
conda: py311 (Python 3.11.11)
poetry: 使用conda环境，没有独立.venv
依赖: 通过poetry管理

# 推荐改进
poetry config virtualenvs.in-project true
poetry install  # 重新创建.venv
``` 